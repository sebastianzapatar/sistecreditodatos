name: Sync to Databricks Repo

on:
  push:
    branches: [ main ]

jobs:
  sync-databricks:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Find Databricks Repo ID
      id: find_repo
      run: |
        echo "ğŸ” Buscando repositorio sistecreditodatos..."
        
        # Hacer request con mejor manejo de errores
        RESPONSE=$(curl -s -w "%{http_code}" -X GET \
          "${{ secrets.DATABRICKS_HOST }}/api/2.0/repos" \
          -H "Authorization: Bearer ${{ secrets.DATABRICKS_TOKEN }}" \
          -H "Content-Type: application/json")
        
        # Separar cÃ³digo HTTP del cuerpo de respuesta
        HTTP_CODE="${RESPONSE: -3}"
        BODY="${RESPONSE%???}"
        
        echo "ğŸ“¡ HTTP Status: $HTTP_CODE"
        echo "ğŸ“‹ Response Body: $BODY"
        
        # Verificar cÃ³digo HTTP
        if [ "$HTTP_CODE" != "200" ]; then
          echo "âŒ Error HTTP $HTTP_CODE"
          exit 1
        fi
        
        # Verificar si el cuerpo estÃ¡ vacÃ­o o es null
        if [ -z "$BODY" ] || [ "$BODY" = "null" ]; then
          echo "âŒ Respuesta vacÃ­a o null"
          exit 1
        fi
        
        # Verificar si contiene repos usando jq de manera segura
        HAS_REPOS=$(echo "$BODY" | jq -e '.repos // empty' > /dev/null 2>&1 && echo "true" || echo "false")
        
        if [ "$HAS_REPOS" = "false" ]; then
          echo "âŒ No se encontraron repositorios en la respuesta"
          echo "ğŸ’¡ Respuesta completa: $BODY"
          exit 1
        fi
        
        # Listar todos los repos encontrados
        echo "ğŸ“‹ Repositorios disponibles:"
        echo "$BODY" | jq -r '.repos[]? | "\(.id): \(.path)"' || echo "Error listando repos"
        
        # Buscar repo especÃ­fico usando jq seguro
        REPO_ID=$(echo "$BODY" | jq -r '.repos[]? | select(.path | contains("sistecreditodatos")) | .id' | head -1)
        
        if [ -z "$REPO_ID" ] || [ "$REPO_ID" = "null" ]; then
          echo "âŒ No se encontrÃ³ repositorio 'sistecreditodatos'"
          echo "ğŸ’¡ Verifica que el repositorio existe en Databricks"
          echo "ğŸ’¡ Repositorios encontrados:"
          echo "$BODY" | jq -r '.repos[]?.path // "Sin repos"' || echo "No se pudieron listar"
          exit 1
        fi
        
        echo "âœ… Repo ID encontrado: $REPO_ID"
        echo "repo_id=$REPO_ID" >> $GITHUB_OUTPUT

    - name: Update Databricks Repo
      run: |
        echo "ğŸ”„ Actualizando repositorio sistecreditodatos..."
        echo "ğŸ“ Repo ID: ${{ steps.find_repo.outputs.repo_id }}"
        echo "ğŸŒ Host: ${{ secrets.DATABRICKS_HOST }}"
        
        RESPONSE=$(curl -s -w "%{http_code}" -X PATCH \
          "${{ secrets.DATABRICKS_HOST }}/api/2.0/repos/${{ steps.find_repo.outputs.repo_id }}" \
          -H "Authorization: Bearer ${{ secrets.DATABRICKS_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{"branch": "main"}')
        
        HTTP_CODE="${RESPONSE: -3}"
        BODY="${RESPONSE%???}"
        
        echo "ğŸ“¡ HTTP Status: $HTTP_CODE"
        echo "ğŸ“‹ Response: $BODY"
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… Repositorio sincronizado exitosamente!"
        else
          echo "âŒ Error sincronizando: HTTP $HTTP_CODE"
          echo "ğŸ“‹ Respuesta: $BODY"
          exit 1
        fi
