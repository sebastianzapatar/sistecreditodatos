name: üî¨ Real Model Validation from ADLS Gen2

on:
  push:
    branches: [ main ]
    # REMOVER paths filter o usar paths m√°s amplios
    paths:
      - 'tests/**'      # Cambiar a 'tests' (plural)
      - '**.py'         # O incluir todos los archivos Python
      - '.github/**'    # O workflows
  pull_request:
    branches: [ main ]

jobs:
  validate-real-model:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîÑ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}  # O tu PAT si tienes problemas
        
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install scikit-learn pandas numpy joblib pytest
        pip install azure-storage-file-datalake azure-identity
        
    - name: üîç Verify Environment and Files
      run: |
        echo "üîß Verificando configuraci√≥n..."
        python -c "import azure.storage.filedatalake; print('‚úÖ Azure SDK disponible')"
        python -c "import sklearn; print('‚úÖ Scikit-learn disponible')"
        
        echo "üìÇ Verificando archivos de test..."
        ls -la tests/ || echo "‚ùå Directorio tests/ no existe"
        ls -la tests/test_real_perdida_cartera.py || echo "‚ùå Archivo test no existe"
        
    - name: üß™ Run Real Model Validation from ADLS Gen2
      env:
        AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
      run: |
        echo "üî¨ Ejecutando validaci√≥n real del modelo..."
        
        # Verificar si el archivo existe antes de ejecutar
        if [ -f "tests/test_real_perdida_cartera.py" ]; then
          python tests/test_real_perdida_cartera.py
        else
          echo "‚ùå Archivo tests/test_real_perdida_cartera.py no encontrado"
          echo "üìÇ Archivos disponibles en tests/:"
          ls -la tests/ || echo "Directorio tests/ no existe"
          exit 1
        fi
        
    - name: üìä Generate Success Report
      if: success()
      run: |
        echo "## üéâ Real Model Validation SUCCESS" > validation_report.md
        echo "" >> validation_report.md
        echo "‚úÖ **Status**: Model successfully validated from ADLS Gen2" >> validation_report.md
        echo "" >> validation_report.md
        echo "### üî¨ Real Validation Results:" >> validation_report.md
        echo "- ‚úÖ **Model Loading**: Loaded from ADLS Gen2 successfully" >> validation_report.md
        echo "- ‚úÖ **Real Performance**: Evaluated with real test data" >> validation_report.md
        echo "- ‚úÖ **Manifest Consistency**: Metrics match real evaluation" >> validation_report.md
        echo "- ‚úÖ **Data Quality**: Test data passes quality checks" >> validation_report.md
        echo "- ‚úÖ **Production Ready**: All production criteria met" >> validation_report.md
        echo "" >> validation_report.md
        echo "### üöÄ Deployment Approved:" >> validation_report.md
        echo "- Model meets all production thresholds" >> validation_report.md
        echo "- Real performance validated with actual data" >> validation_report.md
        echo "- Ready for production deployment" >> validation_report.md
        echo "" >> validation_report.md
        echo "---" >> validation_report.md
        echo "*ü§ñ Real validation by MLOps Pipeline - ADLS Gen2 Integration*" >> validation_report.md
        
    - name: üìù Comment PR with Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          if (fs.existsSync('validation_report.md')) {
            const report = fs.readFileSync('validation_report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
          } else {
            console.log('No validation report found');
          }
